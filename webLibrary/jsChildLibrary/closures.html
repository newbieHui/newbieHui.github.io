<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>闭包 | DemoHui</title>
    <meta name="description" content="明月装饰了你的窗子，你装饰了别人的梦。">
    <link rel="icon" href="img/myBlog.png">
    
    <link rel="preload" href="/assets/css/0.styles.4213a86a.css" as="style"><link rel="preload" href="/assets/js/app.0c8a43ae.js" as="script"><link rel="preload" href="/assets/js/30.763e3bd4.js" as="script"><link rel="prefetch" href="/assets/js/10.faee325a.js"><link rel="prefetch" href="/assets/js/11.f94c2bc9.js"><link rel="prefetch" href="/assets/js/12.2ef36be2.js"><link rel="prefetch" href="/assets/js/13.7e45e2f4.js"><link rel="prefetch" href="/assets/js/14.dde93ac9.js"><link rel="prefetch" href="/assets/js/15.ddf3ce09.js"><link rel="prefetch" href="/assets/js/16.ce01c29d.js"><link rel="prefetch" href="/assets/js/17.28c0e1c2.js"><link rel="prefetch" href="/assets/js/18.328f551d.js"><link rel="prefetch" href="/assets/js/19.57a8a3fd.js"><link rel="prefetch" href="/assets/js/2.4a486eb2.js"><link rel="prefetch" href="/assets/js/20.75648f22.js"><link rel="prefetch" href="/assets/js/21.81940a29.js"><link rel="prefetch" href="/assets/js/22.a4befaf6.js"><link rel="prefetch" href="/assets/js/23.c4bf75f3.js"><link rel="prefetch" href="/assets/js/24.147ebfbc.js"><link rel="prefetch" href="/assets/js/25.e3a3d711.js"><link rel="prefetch" href="/assets/js/26.51e8bb96.js"><link rel="prefetch" href="/assets/js/27.a471a44d.js"><link rel="prefetch" href="/assets/js/28.61ccc5bb.js"><link rel="prefetch" href="/assets/js/29.b0836791.js"><link rel="prefetch" href="/assets/js/3.3c6e9422.js"><link rel="prefetch" href="/assets/js/31.29d88872.js"><link rel="prefetch" href="/assets/js/32.323e945c.js"><link rel="prefetch" href="/assets/js/33.fb947068.js"><link rel="prefetch" href="/assets/js/34.64902085.js"><link rel="prefetch" href="/assets/js/35.80190b9e.js"><link rel="prefetch" href="/assets/js/36.4f24b80f.js"><link rel="prefetch" href="/assets/js/37.59661a28.js"><link rel="prefetch" href="/assets/js/38.3dfd772b.js"><link rel="prefetch" href="/assets/js/39.34a01ba7.js"><link rel="prefetch" href="/assets/js/4.b4027dbd.js"><link rel="prefetch" href="/assets/js/40.2e9a2a97.js"><link rel="prefetch" href="/assets/js/41.f064f568.js"><link rel="prefetch" href="/assets/js/42.abc0cf3e.js"><link rel="prefetch" href="/assets/js/43.d1c9193d.js"><link rel="prefetch" href="/assets/js/44.35bf1d7a.js"><link rel="prefetch" href="/assets/js/45.6a9e3f7d.js"><link rel="prefetch" href="/assets/js/46.1943b87f.js"><link rel="prefetch" href="/assets/js/47.89a58aa4.js"><link rel="prefetch" href="/assets/js/48.608d2a4c.js"><link rel="prefetch" href="/assets/js/49.2a0709ac.js"><link rel="prefetch" href="/assets/js/5.d099e8f7.js"><link rel="prefetch" href="/assets/js/50.85cf52a1.js"><link rel="prefetch" href="/assets/js/51.76b45d02.js"><link rel="prefetch" href="/assets/js/52.5849bac7.js"><link rel="prefetch" href="/assets/js/53.d0a2dc3d.js"><link rel="prefetch" href="/assets/js/54.0654fb7c.js"><link rel="prefetch" href="/assets/js/55.f3dfc830.js"><link rel="prefetch" href="/assets/js/56.0a1d2bfa.js"><link rel="prefetch" href="/assets/js/6.b9478aed.js"><link rel="prefetch" href="/assets/js/7.df786f19.js"><link rel="prefetch" href="/assets/js/8.313f344b.js"><link rel="prefetch" href="/assets/js/9.4c242abc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4213a86a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/self.jpg" alt="DemoHui" class="logo"> <span class="site-name can-hide">DemoHui</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/webLibrary/" class="nav-link router-link-active">前端库</a></div><div class="nav-item"><a href="/projectLibrary/" class="nav-link">项目库</a></div><div class="nav-item"><a href="/essayLibrary/" class="nav-link">随笔库</a></div><div class="nav-item"><a href="https://github.com/newbieHui" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/webLibrary/" class="nav-link router-link-active">前端库</a></div><div class="nav-item"><a href="/projectLibrary/" class="nav-link">项目库</a></div><div class="nav-item"><a href="/essayLibrary/" class="nav-link">随笔库</a></div><div class="nav-item"><a href="https://github.com/newbieHui" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>目录</span> <!----></p> <ul class="sidebar-group-items"></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>JavaScript</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/webLibrary/jsChildLibrary/prototypeChain.html" class="sidebar-link">原型与原型链</a></li><li><a href="/webLibrary/jsChildLibrary/direction.html" class="sidebar-link">this</a></li><li><a href="/webLibrary/jsChildLibrary/closures.html" class="active sidebar-link">闭包</a></li><li><a href="/webLibrary/jsChildLibrary/object.html" class="sidebar-link">Object</a></li><li><a href="/webLibrary/jsChildLibrary/arrayOperation.html" class="sidebar-link">数组</a></li><li><a href="/webLibrary/jsChildLibrary/commonAlgorithm.html" class="sidebar-link">常用算法</a></li><li><a href="/webLibrary/jsChildLibrary/regularExpressions.html" class="sidebar-link">常用正则表达式</a></li><li><a href="/webLibrary/jsChildLibrary/dateChange.html" class="sidebar-link">时间格式转换</a></li><li><a href="/webLibrary/jsChildLibrary/jsValid.html" class="sidebar-link">输入校验</a></li><li><a href="/webLibrary/jsChildLibrary/codeOptimization.html" class="sidebar-link">代码优化</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>ES6</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Vuex</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Vue Router</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Element-ui</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Axios</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>跨域</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>身份认证</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>通信加密</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>工具库</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="闭包"><a href="#闭包" aria-hidden="true" class="header-anchor">#</a> 闭包</h1> <hr> <p>什么是闭包，闭包是这门语言中非常重要但又难以掌握，近乎神话的概念。但是如果了解了词法作用域，那么闭包的概念是不言自明的。</p> <p>从闭包定义来说，当函数可以记住并访问所在的词法作用域，就产生了闭包，即使函数在当前词法作用域外执行。先来看下面这段代码:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 2</span>
    <span class="token punctuation">}</span>
    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这段代码中函数bar可以访问外部作用域中的变量a，那么这是闭包么？从技术来讲，也许是。但是根据前面的定义，确切的来说并不是闭包。</p> <p>下面我们再来看一段代码:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bar<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> baz <span class="token operator">=</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//2 这就是闭包的效果</span>
</code></pre></div><p>以上代码清晰的展示了闭包。函数bar()的词法作用域能够访问demo()的内部作用域。然后我们将bar()函数本身当作一个值类型进行传递。在这个例子
中，我们将bar所引用的函数对象本身当作返回值。在demo()执行后，其返回值（也就是内部的bar()函数）赋值给变量baz并调用baz()，实际上只是通
过不同的标识符引用调用了内部的函数bar()。bar()显然可以被正常执行。但是在这个例子中，它在自己定义的词法作用域以外的地方执行。</p> <p>在demo()执行后，通常会期待demo()的整个内部作用域都被销毁，因为我们知道引擎有垃圾回收器用来释放不再使用的内存空间。由于看上去demo()的
内容不会再被使用，所以很自然地会考虑对其进行回收。<strong>而闭包的“神奇”之处正是可以阻止这件事情的发生。</strong> 事实上内部作用域依然存在，因此没
有被回收。谁在使用这个内部作用域？原来是bar()本身在使用。拜bar()所声明的位置所赐，它拥有涵盖demo()内部作用域的闭包，使得该作用域能够
一直存活，以供bar()在之后任何时间进行引用。<strong>bar()依然持有对该作用域的引用，而这个引用就叫作闭包。</strong> 因此，在几微秒之后变量baz被实际
调用（调用内部函数bar），不出意外它可以访问定义时的词法作用域，因此它也可以如预期般访问变量a。</p> <p>当然，无论使用何种方式对函数类型的值进行传递，当函数在别处被调用时都可以观察到闭包：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">baz</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//这就是闭包</span>
<span class="token punctuation">}</span>
</code></pre></div><p>把内部函数baz传递给bar，当调用这个内部函数时（现在叫作fn），它涵盖的demo()内部作用域的闭包就可以观察到了，因为它能够访问a。</p> <p>传递函数当然也可以是间接的:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> fn<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    fn <span class="token operator">=</span> bar<span class="token punctuation">;</span>   <span class="token comment">//将bar分配给全局变量</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 这就是闭包</span>
<span class="token punctuation">}</span>

<span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 2</span>
</code></pre></div><p>无论通过何种手段将内部函数传递到所在的词法作用域以外，它都会持有对原始定义作用域的引用，无论在何处执行这个函数都会使用闭包。</p> <p>我们再来看一个例子:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>mes<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">demo</span><span class="token punctuation">(</span><span class="token string">&quot;这也是闭包!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将一个内部函数传递给setTimeout(..)。内部函数具有涵盖demo(..)作用域的闭包，因此还保有对变量mes的引用。demo(..)执行1000毫秒后，它的
内部作用域并不会消失，内部函数依然保有demo(..)作用域的闭包。</p> <p>本质上无论何时何地，如果将（访问它们各自词法作用域的）函数当作第一级的值类型并到处传递，你就会看到闭包在这些函数中的应用。在定时器、事
件监听器、Ajax请求、跨窗口通信、Web Workers或者任何其他的异步（或者同步）任务中，只要使用了回调函数，实际上就是在使用闭包！</p> <p>再来看一段IIFE的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通常认为IIFE是典型的闭包例子,以上代码也可以正常运行，但严格来讲它并不是闭包。为什么？因为函数（示例代码中的demo）并不是在它本身的词法
作用域以外执行的。它在定义时所在的作用域中执行（而外部作用域，也就是全局作用域也持有a）。a是通过普通的词法作用域查找而非闭包被发现的。</p> <p>尽管IIFE本身并不是观察闭包的恰当例子，但它的确创建了闭包，并且也是最常用来创建可以被封闭起来的闭包的工具。因此IIFE的确同作用域息息相
关，即使本身并不会真的创建作用域。</p> <p>我们再来分析一段代码，思考一下它的运行结果是什么：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>i<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过运行，我们知道这段代码在运行时会以每秒一次的频率输出五次5。这似乎并不符合我们的预期，想想这是为什么?</p> <p>延迟函数的回调会在循环结束时才执行。事实上，当定时器运行时即使每个迭代中执行的是setTimeout(.., 0)，所有的回调函数依然是在循环结束后才
会被执行，因此会每次输出一个5出来。</p> <p>那么到底要如何改写才能符合预期呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>i<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行后发现并不可行。每个延迟函数都会将IIFE在每次迭代中创建的作用域封闭起来。如果作用域是空的，那么仅仅将它们进行封闭是不够的。仔细看一
下，我们的IIFE只是一个什么都没有的空作用域。它需要包含一点实质内容才能为我们所用。它需要有自己的变量，用来在每个迭代中储存i的值：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>j<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以对这段代码进行一些改进：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>j<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当然，这些IIFE也不过就是函数，因此我们可以将i传递进去，如果愿意的话可以将变量名定为j，当然也可以还叫作i。无论如何这段代码现在可以工作
了。在迭代内使用IIFE会为每个迭代都生成一个新的作用域，使得延迟函数的回调可以将新的作用域封闭在每个迭代内部，每个迭代中都会含有一个具有
正确值的变量供我们访问。好了，问题解决啦！</p> <p>当然我们可以使用块级作用域更好的解决这个问题，看看下面的代码:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>j<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>for循环头部的let声明还会有一个特殊的行为。这个行为指出变量在循环过程中不止被声明一次，每次迭代都会声明。随后的每个迭代都会使用上一个迭
代结束时的值来初始化这个变量。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>i<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/webLibrary/jsChildLibrary/direction.html" class="prev">
          this
        </a></span> <span class="next"><a href="/webLibrary/jsChildLibrary/object.html">
          Object
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.0c8a43ae.js" defer></script><script src="/assets/js/30.763e3bd4.js" defer></script>
  </body>
</html>
